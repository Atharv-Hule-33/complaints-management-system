<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Complaints Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
        }

        .error {
            color: red;
        }
    </style>
</head>

<body class="container my-5">
<h2 class="mb-4">Complaints Management</h2>
<button id="showFormBtn" class="btn btn-primary mb-3" style="margin-left: 13px">
    <i class="bi bi-plus-circle"></i> Add Complaint
</button>
<form id="complaintForm" class="mb-4" novalidate style="display: none">
    <div class="mb-3">
        <label for="user" class="form-label">User:</label>
        <select class="form-select" id="user" required>
            <option value="" disabled selected>Select User</option>
        </select>
        <div class="invalid-feedback">User is required.</div>
        <div class="error" id="user-error"></div>
    </div>
    <div class="mb-3">
        <label for="department" class="form-label">Department:</label>
        <select class="form-select" id="department" required>
            <option value="" disabled selected>Select Department</option>
        </select>
        <div class="invalid-feedback">Department is required.</div>
        <div class="error" id="department-error"></div>
    </div>
    <div class="mb-3">
        <label for="complaintType" class="form-label">Complaint Type:</label>
        <select class="form-select" id="complaintType" required>
            <option value="" disabled selected>Select Complaint Type</option>
        </select>
        <div class="invalid-feedback">Complaint Type is required.</div>
        <div class="error" id="complaintType-error"></div>
    </div>
    <div class="mb-3">
        <label for="complaintDescription" class="form-label">Description:</label>
        <textarea class="form-control" id="complaintDescription" rows="3" required></textarea>
        <div class="invalid-feedback">Description is required.</div>
        <div class="error" id="complaintDescription-error"></div>
    </div>
    <div class="mb-3">
        <label for="complaintStatus" class="form-label">Status:</label>
        <select class="form-select" id="complaintStatus" required>
            <option value="" disabled selected>Select Status</option>
            <option value="Filed">FILED</option>
            <option value="InProgress">IN_PROGRESS</option>
            <option value="Resolved">RESOLVED</option>
            <option value="Closed">CLOSED</option>
        </select>
        <div class="invalid-feedback">Please select a status.</div>
        <div class="error" id="complaintStatus-error"></div>
    </div>
    <button type="submit" class="btn btn-primary">
        <span id="submit-btn-text">Add Complaint</span>
    </button>
    <button type="button" class="btn btn-secondary" id="cancel-btn" style="display: none">
        Cancel
    </button>
</form>

<table class="table table-bordered">
    <thead>
    <tr>
        <th>Complaint ID</th>
        <th>User</th>
        <th>Department</th>
        <th>Complaint Type</th>
        <th>Description</th>
        <th>Status</th>
        <th>Filed Date</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="complaintsTableBody"></tbody>
</table>

<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Error!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul id="error-list"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    apiUrl = "http://localhost:8080/api";
    const complaintForm = document.getElementById('complaintForm');
    const complaintsTableBody = document.getElementById('complaintsTableBody');
    const userSelect = document.getElementById('user');
    const departmentSelect = document.getElementById('department');
    const complaintTypeSelect = document.getElementById('complaintType');
    const submitButton = document.querySelector('#complaintForm button[type="submit"]');
    const cancelButton = document.getElementById('cancel-btn');
    const showFormBtn = document.getElementById("showFormBtn");

    let complaintDetails = [];
    let complaintTypesDetails = [];
    let departmentDetails = [];
    let userDetails = [];

    showFormBtn.addEventListener("click", () => {
        complaintForm.style.display = "block";
        showFormBtn.style.display = "none";
    });

    function fetchAndRenderComplaints() {
        fetch(`${apiUrl}/complaints`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(res => res.json())
            .then(data => {
                complaintDetails = data;
                renderComplaints(data);
            })
    }

    function fetchComplaintType() {
        fetch(`${apiUrl}/complaint-types`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(res => res.json())
            .then(data => {
                complaintTypesDetails = data;
                complaintTypeSelect.innerHTML = `<option selected disabled>Select ComplaintType</option>`;
                data.forEach(type => {
                    complaintTypeSelect.innerHTML += `<option value="${type.complaintTypeId}">${type.complaintType}</option>`;
                })
            })
            .catch(error => {
                console.error("failed to fetch the complaint type!!!", error);
            });
    }

    function fetchDepartment() {
        fetch(`${apiUrl}/departments`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(res => res.json())
            .then(data => {
                departmentDetails = data;
                departmentSelect.innerHTML = `<option selected disabled>Select Department</option>`;
                data.forEach(department => {
                    departmentSelect.innerHTML += `<option value="${department.departmentId}">${department.departmentName}</option>`;
                })
            })
            .catch(error => {
                console.error("failed to fetch the department!!!", error);
            });
    }

    function fetchUser() {
        fetch(`${apiUrl}/users`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(res => res.json())
            .then(data => {
                userDetails = data;
                userSelect.innerHTML = `<option selected disabled>Select User</option>`;
                data.forEach(user => {
                    userSelect.innerHTML += `<option value="${user.userId}">${user.userName}</option>`;
                })
            })
            .catch(error => {
                console.error("failed to fetch the user!!!", error);
            });
    }

    function renderComplaints(complaints) {
        complaintsTableBody.innerHTML = "";
        complaints.forEach(complaint => {
            let foundUser = userDetails.find(u=> u.userId === complaint.user.userId);
            let department = departmentDetails.find(d => d.departmentId === complaint.department.departmentId);
            let complaintType = complaintTypesDetails.find(ct => ct.complaintTypeId === complaint.complaintType.complaintTypeId);
            const row = document.createElement("tr");
            row.innerHTML = `<td>${complaint.complaintId}</td>
            </td>${foundUser ? foundUser.name : 'N/A'}</td>
            <td>${department ? department.departmentName : 'N/A'}</td>
            <td>${complaintType ? complaintType.complaintType : 'N/A'}</td>
            <td>${complaint.complaintDescription}</td>
            <td>${complaint.complaintStatus}</td>
            <td>${complaint.complaintFiledDate}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-id="${complaint.complaintId}"><i class="bi bi-pencil-square"></i>Edit</button>
                <button class="btn btn-sm btn-outline-danger delete-btn mt-3" data-id="${complaint.complaintId}"><i class="bi bi-trash"></i>Delete</button>
            </td>`;
            complaintsTableBody.appendChild(row);
        })
    }
    Promise.all([ fetchUser(),fetchDepartment(),fetchComplaintType()])
        .then(() =>{
           fetchAndRenderComplaints();
        });
</script>
</body>
</html>
