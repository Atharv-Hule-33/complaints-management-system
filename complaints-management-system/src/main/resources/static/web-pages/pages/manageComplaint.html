<div class="row mb-4">
    <div class="col-md-12">
        <h2>
            Welcome <span id="userName"></span>
        </h2>
        <div class="row">
            <div class="col-xl-3 col-md-6">
                <div class="card">
                    <div class="stat-card bg-primary-gradient">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">Total Complaints</h6>
                                <h2 class="mb-0 mt-2" id="totalComplaints">0</h2>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                        </div>
                        <div class="mt-2 small">
                            <span class="text-white">View all your complaints</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card">
                    <div class="stat-card bg-success-gradient">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">Resolved</h6>
                                <h2 class="mb-0 mt-2" id="resolvedComplaints">0</h2>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="mt-2 small">
                            <span class="text-white">Successfully resolved complaints</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card">
                    <div class="stat-card bg-warning-gradient">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">In Progress</h6>
                                <h2 class="mb-0 mt-2" id="inProgressComplaints">0</h2>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="mt-2 small">
                            <span class="text-white">Currently being processed</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card">
                    <div class="stat-card bg-info-gradient">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">Filed</h6>
                                <h2 class="mb-0 mt-2" id="filedComplaints">0</h2>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                        </div>
                        <div class="mt-2 small">
                            <span class="text-white">Awaiting initial response</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg">
        <div class="card">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Complaints</h5>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Department</th>
                            <th>Type</th>
                            <th>Filed On</th>
                            <th>Status</th>
                            <th>Chat</th>
                        </tr>
                        </thead>
                        <tbody id="recentComplaintsTable">
                        <!-- Complaints will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Window -->
<div class="chat-popup" id="chatWindow">
    <div class="chat-header">
        <div>
            <h5 class="mb-0">
                Complaint #<span id="currentComplaintId"></span>
            </h5>
            <small id="complaintStatus"></small>
        </div>
        <button type="button" class="btn-close" onclick="closeChatWindow()"></button>
    </div>

    <div class="chat-messages" id="chatMessages">
        <!-- Messages will be added here dynamically -->
    </div>

    <div class="chat-input-container">
        <input type="text" class="form-control" id="messageInput"
               placeholder="Type a message..." onkeypress="handleKeyPress(event)">
        <button class="btn btn-primary send-button" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>




<script>

    userId = getUserId();
    console.log(userId)

    // Optionally, set the user name if available
    document.getElementById('userName').textContent = 'User';

    fetch(`/api/user-dashboard/${userId}`, {
        method: 'GET',

    })
    .then(response => response.json())
        .then(data => {
            console.log("API Response:", data);
            document.getElementById('totalComplaints').textContent = data.totalComplaints;
            document.getElementById('resolvedComplaints').textContent = data.resolvedComplaints;
            document.getElementById('inProgressComplaints').textContent = data.inProgressComplaints;
            document.getElementById('filedComplaints').textContent = data.filedComplaints;

            const tbody = document.getElementById('recentComplaintsTable');
            tbody.innerHTML = '';
            data.recentComplaints.forEach(complaint => {
                let badgeClass = 'bg-secondary';
                if (complaint.status === 'RESOLVED') badgeClass = 'bg-success';
                else if (complaint.status === 'IN_PROGRESS') badgeClass = 'bg-warning text-dark';
                else if (complaint.status === 'FILED') badgeClass = 'bg-primary';
                else if (complaint.status === 'CLOSED') badgeClass = 'bg-info';
                const filedOn = new Date(complaint.filedOn).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: '2-digit'
                });

                tbody.innerHTML += `
                    <tr>
                        <td>#${complaint.id}</td>
                        <td>${complaint.department}</td>
                        <td>${complaint.type}</td>
                        <td>${filedOn}</td>
                        <td><span class="badge ${badgeClass}">${complaint.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary"
                               onclick="openChatWindow('${complaint.id}', '${complaint.status}')" title="Chat">
                                <i class="fas fa-comments"></i>
                            </button>
                        </td>
                    </tr>
                `;

            });
        })
        .catch(err => {
            console.error('Failed to load dashboard data', err);
        });

    let socket;
    let currentComplaintId;
    let currentUser = userId.toString(); // Using the userId from your existing code

    // Open chat window
    window.openChatWindow = function (complaintId, status) {
        alert("Chat window opened!");
        // Set complaint details in the UI
        document.getElementById('currentComplaintId').textContent = complaintId;
        document.getElementById('complaintStatus').textContent = status;

        // Store current complaint ID
        currentComplaintId = complaintId;

        // Show chat window
        document.getElementById('chatWindow').style.display = 'flex';

        // Clear previous messages
        document.getElementById('chatMessages').innerHTML = '';

        // Connect to WebSocket
        connectWebSocket();
    }

    // Close chat window
    function closeChatWindow() {
        document.getElementById('chatWindow').style.display = 'none';
        if (socket) {
            socket.close();
        }
    }

    // Connect to WebSocket server
    function connectWebSocket() {
        // Close any existing connection
        if (socket) {
            socket.close();
        }

        // Create new WebSocket connection
        socket = new WebSocket(//localhost:8080/chat?compId=${currentComplaintId});

            // Connection opened
            socket.onopen = function(event) {
                console.log("Connected to WebSocket server");
                addSystemMessage("Connected to chat");
            };

        // Listen for messages
        socket.onmessage = function(event) {
            try {
                const message = JSON.parse(event.data);
                displayMessage(message);
            } catch (e) {
                console.error("Error parsing message:", e);
            }
        };

        // Connection closed
        socket.onclose = function(event) {
            console.log("Disconnected from WebSocket server");
        };

        // Connection error
        socket.onerror = function(error) {
            console.error("WebSocket error:", error);
            addSystemMessage("Connection error. Please try again later.");
        };
    }

    // Send a message
    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();

        if (content && socket && socket.readyState === WebSocket.OPEN) {
            // Create message object
            const message = {
                from: currentUser,
                to: "admin", // Default recipient - adjust as needed
                content: content,
                compId: currentComplaintId
            };

            // Send message
            socket.send(JSON.stringify(message));

            // Clear input
            messageInput.value = '';
        }
    }

    // Display a message in the chat
    function displayMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        const messageElement = document.createElement('div');

        // Determine if message is sent or received
        const isSent = message.from === currentUser;
        messageElement.className = message ${isSent ? 'sent' : 'received'};

        // Set message content
        messageElement.innerHTML = `
            <div><strong>${isSent ? 'You' : message.from}</strong></div>
            <div>${message.content}</div>
            <div><small class="text-muted">${new Date().toLocaleTimeString()}</small></div>
        `;

        // Add message to chat
        chatMessages.appendChild(messageElement);

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add a system message
    function addSystemMessage(text) {
        const chatMessages = document.getElementById('chatMessages');
        const messageElement = document.createElement('div');
        messageElement.className = 'text-center my-2';
        messageElement.innerHTML = <small class="text-muted">${text}</small>;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Handle Enter key press
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }


</script>